---
title: プレイヤーだけ実装
type: docs
weight: 20
---

# プレイヤーだけ実装してみる

## ソースコード全体の構成を決めておく

ここからいろいろソースコードを増やしていくので、  
整理のため、ソースコード全体を以下の3つのセクションに分けることにする

1. エンティティ関連の関数
1. ゲーム全体に関わる部分
1. setup/draw 他

ついでに `rectMode()` も書いておく（後で四角形を描画するので）

```javascript { hl_lines=["0-10", 13, 15, 19, 22, "25-27"] }
// ---- エンティティ関連の関数 ---------------------------------------------

// （ここに何かが入る）

// ---- ゲーム全体に関わる部分 ---------------------------------------------

// （ここに何かが入る）

// ---- setup/draw 他 --------------------------------------------------

function setup() {
  createCanvas(800, 600);
  rectMode(CENTER); // 四角形の基準点を角から中心に変える

  // （ここに初期化処理が入る）
}

function draw() {
  // （ここにデータ操作処理が入る）

  background(0);
  // （ここに描画処理が入る）
}

function mousePressed() {
  // （ここにマウスボタンを押したときの処理が入る）
}
```

`mousePressed()` は、マウスボタンが押されたときに p5.js によって自動的に実行される  
（→ [リファレンス](https://p5js.org/reference/#/p5/mousePressed)）

{{< expand "余談： モジュール">}}
プログラム全体をいくつかのまとまりに分割すると見通しが良くなりますが、このようにコメントでなんとかするというのは簡易的な方法に過ぎません。

本来だと、プログラムを機能ごとに分割（しばしば階層化を伴う）したものをそれぞれ別のファイルに分けて保存するという方法を取ることが多いです。

具体的な方法としては ES2015 の `import`/`export` を始め何種類かあって、あとモジュールバンドラで統合して云々……みたいな話があるのですが、（少なくとも筆者の感覚では）いろいろ込み入っているので、ここでは割愛します。ご興味があればゆっくり調べてみてください。
{{< /expand >}}


## 【再掲】エンティティ関連の処理

### 全エンティティ共通

- 位置の更新

### プレイヤー用

- 作成
- 重力の適用
- ジャンプ
- 描画

### ブロック用

- 作成
- 描画


## やること

1. プレイヤーを入れる変数を用意する
1. `setup()` の中で、プレイヤーを**作成**する
1. `draw()` の中で、プレイヤーについて以下を行う
    - **位置の更新**
    - **重力の適用**
    - **描画**
1. マウスボタンを押したときだけ、プレイヤーを**ジャンプ**させる


## 必要な関数が既に揃っている、と仮定して書いてみる

※ このソースコードは動きません

```javascript { hl_lines=["7-8", "16-17", "21-27", 29, "33-34"] }
// ---- エンティティ関連の関数 ---------------------------------------------

// （ここに何かが入る）

// ---- ゲーム全体に関わる部分 ---------------------------------------------

/** プレイヤーエンティティ */
let player;

// ---- setup/draw 他 --------------------------------------------------

function setup() {
  createCanvas(800, 600);
  rectMode(CENTER);

  // プレイヤーを作成
  player = createPlayer();
}

function draw() {
  // プレイヤーの位置を更新
  updatePosition(player);

  // プレイヤーに重力を適用
  applyGravity(player);

  // プレイヤーを描画
  background(0);
  drawPlayer(player);
}

function mousePressed() {
  // プレイヤーをジャンプさせる
  applyJump(player);
}
```


## 必要な関数を実際に用意する

### 方針

プレイヤーは位置と速度を持っているので、次のようなデータがあると良さそう

```javascript { linenos=false }
// プレイヤーデータ例
let player = {
  x: 200, // 位置 x座標
  y: 300, // 位置 y座標
  vx: 0,  // 速度 x成分
  vy: 0   // 速度 y成分
};

// こうしたとき、たとえば player.x の値は 200 である
```

あとは、これらの位置や速度を変化させたり、位置に応じて描画したりすれば良い

なお座標 (200, 300) はこの位置
{{< figure src="./player-initial-position.png" alt="プレイヤー初期位置" width="320" height="240" >}}

### 実装

※ 変化のないセクション（「ゲーム全体に関わる部分」、「setup/draw 他」）は省略

```javascript { hl_lines=["3-31"] }
// ---- エンティティ関連の関数 ---------------------------------------------

// 全エンティティ共通

function updatePosition(entity) {
  entity.x += entity.vx;
  entity.y += entity.vy;
}

// プレイヤーエンティティ

function createPlayer() {
  return {
    x: 200,
    y: 300,
    vx: 0,
    vy: 0
  };
}

function applyGravity(entity) {
  entity.vy += 0.15;
}

function applyJump(entity) {
  entity.vy = -5;
}

function drawPlayer(entity) {
  square(entity.x, entity.y, 40);
}
```


{{< hint info >}}
各自実行してみて、プレイヤーが

- 画面に表示されていること
- 放っておくと落下していくこと
- マウスボタンでジャンプすること

などを確認してください。
{{< /hint >}}


{{< hint info >}}
余裕があれば、各関数の中の数字部分（`200` とか `0.15` とか `-5` とか）について、いろいろ値を変えてみて、実行結果がどんなふうに変わるかを見てみてください。
{{< /hint >}}


{{< expand "補足： ホントにこういう順番で書くの？">}}
実際には、ごく普通に

1. 関数を定義する
1. その関数を使う

という流れで書くことも多いかもしれません。

ただ、処理の具体的な中身を真っ先に書こうとすると、何度も書き直すことになったり、どこから手を付けてよいかが分かりにくくなったりする可能性が高まります（そういうところで困ったことがないのであれば、この話はあまり気にする必要はありません）。

「こういう関数があればいいのにな」という思考から出発すると、穴埋め式の問題を埋めていくような感覚で書き進めることができてスムーズなことも多いです、というのをお伝えしたかったのでした。

ちなみに筆者の場合だと

1. 関数を宣言する、ただし中身は適当なダミー
1. その関数を使う
1. ダミー部分をちゃんと実装する

という流れになることもそこそこあるように思います。  
先に宣言しておくと（エディタによっては）コード補完が使えるので。
{{< /expand >}}


{{< expand "ソースコード全文">}}

```javascript
// ---- エンティティ関連の関数 ---------------------------------------------

// 全エンティティ共通

function updatePosition(entity) {
  entity.x += entity.vx;
  entity.y += entity.vy;
}

// プレイヤーエンティティ

function createPlayer() {
  return {
    x: 200,
    y: 300,
    vx: 0,
    vy: 0
  };
}

function applyGravity(entity) {
  entity.vy += 0.15;
}

function applyJump(entity) {
  entity.vy = -5;
}

function drawPlayer(entity) {
  square(entity.x, entity.y, 40);
}

// ---- ゲーム全体に関わる部分 ---------------------------------------------

/** プレイヤーエンティティ */
let player;

// ---- setup/draw 他 --------------------------------------------------

function setup() {
  createCanvas(800, 600);
  rectMode(CENTER);

  // プレイヤーを作成
  player = createPlayer();
}

function draw() {
  // プレイヤーの位置を更新
  updatePosition(player);

  // プレイヤーに重力を適用
  applyGravity(player);

  // プレイヤーを描画
  background(0);
  drawPlayer(player);
}

function mousePressed() {
  // プレイヤーをジャンプさせる
  applyJump(player);
}
```
{{< /expand >}}
